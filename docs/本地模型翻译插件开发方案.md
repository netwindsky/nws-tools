**ğŸš€ Ollama æœ¬åœ°å¤§æ¨¡å‹æµè§ˆå™¨ç¿»è¯‘æ’ä»¶å¼€å‘æ–‡æ¡£**

## **1\. é¡¹ç›®æ¦‚å†µ**

* **é¡¹ç›®ç›®æ ‡**: å¼€å‘ä¸€ä¸ª Chrome æµè§ˆå™¨æ’ä»¶ï¼Œåˆ©ç”¨æœ¬åœ° Ollama è¿è¡Œçš„ MedAIBase/Tencent-HY-MT1.5:1.8b è¿›è¡Œç½‘é¡µç¿»è¯‘ã€‚  
* **æ ¸å¿ƒåŠŸèƒ½**:  
  1. **åˆ’è¯ç¿»è¯‘**: é€‰ä¸­å³ç¿»ã€‚  
  2. **æ•´é¡µç¿»è¯‘ (æ›¿æ¢æ¨¡å¼)**: ä¿æŒåŸæœ‰æ’ç‰ˆï¼Œæ›¿æ¢æ–‡å­—ã€‚  
  3. **æ•´é¡µç¿»è¯‘ (å¯¹ç…§æ¨¡å¼)**: åŸæ–‡ \+ è¯‘æ–‡åŒè¯­æ˜¾ç¤ºã€‚  
  4. **æ™ºèƒ½è¯†åˆ«**: è‡ªåŠ¨è·³è¿‡å·²ç»æ˜¯ç›®æ ‡è¯­è¨€çš„æ–‡æœ¬ï¼Œå‡å°‘ GPU è®¡ç®—é‡ã€‚  
* **æŠ€æœ¯æ ˆ**:  
  * Frontend: Chrome Extension Manifest V3 (Vanilla JS)  
  * Backend: Ollama API (Localhost)  
  * Model: MedAIBase/Tencent-HY-MT1.5:1.8b (æˆ–ä»»æ„æ”¯æŒç¿»è¯‘çš„æ¨¡å‹)

## ---

**2\. æ ¸å¿ƒæŒ‘æˆ˜ä¸è§£å†³æ–¹æ¡ˆ (å…³é”®)**

åœ¨å¼€å§‹å†™ä»£ç å‰ï¼Œå¿…é¡»è§£å†³æœ¬åœ°æ¨¡å‹çš„ä¸‰ä¸ªæ ¸å¿ƒç—›ç‚¹ï¼š

### **ğŸ›‘ ç—›ç‚¹ 1ï¼šé€Ÿåº¦æ…¢ (Latency)**

æœ¬åœ°æ¨¡å‹ç”Ÿæˆç¿»è¯‘å¯èƒ½éœ€è¦ 0.5ç§’ \- 2ç§’/å¥ï¼Œå¦‚æœç½‘é¡µæœ‰ 1000 ä¸ªæ–‡æœ¬èŠ‚ç‚¹ï¼Œä¸²è¡Œå¤„ç†éœ€è¦åŠå°æ—¶ï¼Œå¹¶å‘å¤„ç†ä¼šç‚¸æ˜¾å­˜ã€‚

* **è§£å†³æ–¹æ¡ˆ**: **è§†å£ä¼˜å…ˆ (Viewport Priority) \+ è¯·æ±‚é˜Ÿåˆ—**ã€‚  
  * åˆ©ç”¨ IntersectionObserver ä»…ç¿»è¯‘ç”¨æˆ·**å½“å‰å±å¹•å†…**çœ‹åˆ°çš„æ–‡å­—ã€‚  
  * ç”¨æˆ·æ»šåŠ¨é¡µé¢æ—¶ï¼Œå†åŠ¨æ€è§¦å‘åç»­ç¿»è¯‘ã€‚

### **ğŸ›‘ ç—›ç‚¹ 2ï¼šä¸Šä¸‹æ–‡ç¼ºå¤± (Context)**

å•çº¯æå– TextNode ç¿»è¯‘ï¼ˆå¦‚æŠŠ "Home" ç¿»è¯‘æˆ "å®¶"ï¼‰ï¼Œåœ¨å¯¼èˆªæ æ˜¯å¯¹çš„ï¼Œä½†åœ¨æˆ¿åœ°äº§ç½‘ç«™å¯èƒ½æ˜¯ "æˆ¿å±‹"ã€‚

* **è§£å†³æ–¹æ¡ˆ**: **å—çº§åˆå¹¶**ã€‚  
  * å°è¯•æå–çˆ¶çº§å—å…ƒç´ ï¼ˆå¦‚ \<p\>, \<li\>, \<h1\>ï¼‰çš„å®Œæ•´æ–‡æœ¬è¿›è¡Œç¿»è¯‘ï¼Œè€Œä¸æ˜¯æ‹†ç¢çš„ \<span\>ã€‚

### **ğŸ›‘ ç—›ç‚¹ 3ï¼šå¸ƒå±€å´©å (Layout Shift)**

åŒè¯­æ¨¡å¼ä¸‹ï¼Œæ’å…¥æ–‡æœ¬ä¼šå¯¼è‡´é«˜åº¦å˜åŒ–ï¼Œå¯èƒ½é®æŒ¡æŒ‰é’®æˆ–å¯¼èˆªã€‚

* **è§£å†³æ–¹æ¡ˆ**: **éä¾µå…¥å¼æ’å…¥**ã€‚  
  * ä½¿ç”¨ \<font\> æˆ– \<span\> æ’å…¥ï¼Œå¹¶è®¾ç½®æ˜æ˜¾çš„é¢œè‰²åŒºåˆ†ã€‚å¯¹äºå¤æ‚çš„å¤æ‚ç»„ä»¶ï¼ˆå¦‚å¯¼èˆªæ ï¼‰ï¼Œå¼ºåˆ¶ä½¿ç”¨â€œæ›¿æ¢æ¨¡å¼â€æˆ–ä»…æ˜¾ç¤º Tooltipã€‚


### **3.3 åå°æœåŠ¡ (background.js) \- å¹¶å‘æ§åˆ¶æ ¸å¿ƒ**

è¿™é‡Œå®ç°äº†ä¸€ä¸ªç®€å•çš„**ä»»åŠ¡é˜Ÿåˆ—**ï¼Œé˜²æ­¢ç¬é—´å‘å‡ºå‡ ç™¾ä¸ªè¯·æ±‚æŠŠ Ollama å†²å®ã€‚

JavaScript

// background.js

const OLLAMA\_API \= "http://localhost:11434/api/generate";  
const MODEL\_NAME \= "fymodel";   
const CONCURRENT\_LIMIT \= 3; // åŒæ—¶å…è®¸å¤„ç†çš„è¯·æ±‚æ•°

let activeRequests \= 0;  
let requestQueue \= \[\];

// ç›‘å¬æ¥è‡ª content script çš„æ¶ˆæ¯  
chrome.runtime.onMessage.addListener((request, sender, sendResponse) \=\> {  
  if (request.action \=== "translate\_queue") {  
    // å…¥é˜Ÿå¤„ç†  
    processQueueItem(request, sendResponse);  
    return true; // å¼‚æ­¥å“åº”  
  }  
});

async function processQueueItem(request, sendResponse) {  
  // ç®€å•çš„é˜Ÿåˆ—è°ƒåº¦  
  const execute \= async () \=\> {  
    try {  
      const result \= await callOllama(request.text, request.targetLang);  
      sendResponse({ status: "success", data: result });  
    } catch (error) {  
      sendResponse({ status: "error", message: error.message });  
    }  
  };

  if (activeRequests \< CONCURRENT\_LIMIT) {  
    activeRequests++;  
    await execute();  
    activeRequests--;  
    // æ£€æŸ¥é˜Ÿåˆ—ä¸­æ˜¯å¦æœ‰ç­‰å¾…çš„ä»»åŠ¡ (æ­¤å¤„ç®€åŒ–é€»è¾‘ï¼Œå®é™…é¡¹ç›®å¯ç”¨æ•°ç»„ç®¡ç†æ’é˜Ÿ)  
  } else {  
    // ç®€å•ç­–ç•¥ï¼šå¦‚æœå¿™ç¢Œï¼Œç¨åé‡è¯• (Content Script ä¼šå¤„ç†è¶…æ—¶)  
    // æˆ–è€…å®ç°ä¸€ä¸ªçœŸæ­£çš„æ•°ç»„é˜Ÿåˆ—ç»“æ„  
    setTimeout(() \=\> processQueueItem(request, sendResponse), 500);  
  }  
}

async function callOllama(text, targetLang) {  
  // æ„å»º Promptï¼Œå¼ºè°ƒåªç¿»è¯‘ï¼Œä¸è§£é‡Š  
  const prompt \= \`Translate the following text into ${targetLang}. Only output the translated text, do not explain. Text: "${text}"\`;

  const response \= await fetch(OLLAMA\_API, {  
    method: "POST",  
    headers: { "Content-Type": "application/json" },  
    body: JSON.stringify({  
      model: MODEL\_NAME,  
      prompt: prompt,  
      stream: false  
    })  
  });

  const json \= await response.json();  
  return json.response.trim();  
}

### **3.4 ç½‘é¡µè„šæœ¬ (content.js) \- æ™ºèƒ½è¯†åˆ«ä¸ DOM æ“ä½œ**

è¿™æ˜¯æœ€å¤æ‚çš„éƒ¨åˆ†ï¼ŒåŒ…å«**éç›®æ ‡è¯­è¨€è¿‡æ»¤**å’Œ**è§†å£æ£€æµ‹**ã€‚

JavaScript

// content.js

// é…ç½®  
const TARGET\_LANG \= "Chinese"; // é»˜è®¤ç›®æ ‡è¯­è¨€ï¼Œå¯ä» storage è¯»å–  
let TRANSLATION\_MODE \= 'bilingual'; // 'replace' or 'bilingual'

// 1\. è¯­è¨€æ£€æµ‹ (ç®€å•çš„æ­£åˆ™è¿‡æ»¤ï¼ŒèŠ‚çœ GPU)  
function shouldTranslate(text) {  
  // è¿‡æ»¤ç©ºæ–‡æœ¬ã€æ•°å­—ã€çº¯ç¬¦å·  
  if (\!text || text.trim().length \< 2) return false;  
  if (/^\\d+$/.test(text.trim())) return false;

  // å¦‚æœç›®æ ‡æ˜¯ä¸­æ–‡ï¼Œä¸”æ–‡æœ¬å·²ç»åŒ…å«å¤§é‡ä¸­æ–‡å­—ç¬¦ï¼Œåˆ™è·³è¿‡  
  if (TARGET\_LANG \=== "Chinese") {  
    const chineseCharCount \= (text.match(/\[\\u4e00-\\u9fa5\]/g) || \[\]).length;  
    // å¦‚æœä¸­æ–‡å­—ç¬¦å æ¯”è¶…è¿‡ 50%ï¼Œè®¤ä¸ºæ— éœ€ç¿»è¯‘  
    if (chineseCharCount / text.length \> 0.5) return false;  
  }  
  return true;  
}

// 2\. åˆ’è¯ç¿»è¯‘é€»è¾‘  
document.addEventListener('mouseup', (e) \=\> {  
  const selection \= window.getSelection();  
  const text \= selection.toString().trim();  
    
  if (shouldTranslate(text)) {  
    showTooltip(e.pageX, e.pageY, "æ­£åœ¨ç¿»è¯‘...");  
    chrome.runtime.sendMessage({  
      action: "translate\_queue",  
      text: text,  
      targetLang: TARGET\_LANG  
    }, (res) \=\> {  
      if (res.status \=== "success") updateTooltip(res.data);  
    });  
  }  
});

// 3\. æ•´é¡µç¿»è¯‘ \- æ ¸å¿ƒè°ƒåº¦å™¨  
function startFullPageTranslate(mode) {  
  TRANSLATION\_MODE \= mode;  
    
  // è·å–æ‰€æœ‰å—çº§å…ƒç´  (p, h1-h6, li, td, div with text)  
  // è¿™é‡Œç®€åŒ–ä¸ºéå†æ‰€æœ‰åŒ…å«æ–‡æœ¬çš„å¶å­èŠ‚ç‚¹  
  const walker \= document.createTreeWalker(  
    document.body,  
    NodeFilter.SHOW\_TEXT,  
    null,  
    false  
  );

  let node;  
  const nodesToTranslate \= \[\];

  while (node \= walker.nextNode()) {  
    const parent \= node.parentElement;  
    // è¿‡æ»¤æ‰è„šæœ¬ã€æ ·å¼ã€å·²ç¿»è¯‘çš„å†…å®¹  
    if (\['SCRIPT', 'STYLE', 'NOSCRIPT', 'TEXTAREA'\].includes(parent.tagName)) continue;  
    if (parent.getAttribute('data-ollama-translated')) continue; // é˜²æ­¢é‡å¤

    const text \= node.nodeValue.trim();  
    if (shouldTranslate(text)) {  
      nodesToTranslate.push({ node, text });  
    }  
  }

  // å¯åŠ¨è§†å£è§‚å¯Ÿè€… (IntersectionObserver)  
  observeAndTranslate(nodesToTranslate);  
}

// 4\. è§†å£è§‚å¯Ÿè€… (Lazy Translation)  
function observeAndTranslate(nodeDataList) {  
  const observer \= new IntersectionObserver((entries) \=\> {  
    entries.forEach(entry \=\> {  
      if (entry.isIntersecting) {  
        const targetElement \= entry.target;  
        // æ‰¾åˆ°å¯¹åº”çš„èŠ‚ç‚¹æ•°æ®  
        const data \= nodeDataList.find(item \=\> item.node.parentElement \=== targetElement);  
          
        if (data && \!targetElement.getAttribute('data-translating')) {  
          targetElement.setAttribute('data-translating', 'true'); // æ ‡è®°æ­£åœ¨å¤„ç†  
            
          // å‘é€ç¿»è¯‘è¯·æ±‚  
          chrome.runtime.sendMessage({  
            action: "translate\_queue",  
            text: data.text,  
            targetLang: TARGET\_LANG  
          }, (res) \=\> {  
            if (res.status \=== "success") {  
              applyTranslation(data.node, res.data);  
              targetElement.setAttribute('data-ollama-translated', 'true');  
            }  
            observer.unobserve(targetElement); // ç¿»è¯‘å®Œå°±ä¸å†è§‚å¯Ÿ  
          });  
        }  
      }  
    });  
  }, { rootMargin: "100px" }); // æå‰ 100px å¼€å§‹ç¿»è¯‘

  // å¼€å§‹è§‚å¯Ÿæ¯ä¸ªæ–‡æœ¬èŠ‚ç‚¹çš„çˆ¶å…ƒç´   
  nodeDataList.forEach(item \=\> {  
    observer.observe(item.node.parentElement);  
  });  
}

// 5\. åº”ç”¨ç¿»è¯‘ç»“æœ (DOM æ“ä½œ)  
function applyTranslation(textNode, translatedText) {  
  const parent \= textNode.parentNode;

  if (TRANSLATION\_MODE \=== 'replace') {  
    textNode.nodeValue \= translatedText;  
  } else if (TRANSLATION\_MODE \=== 'bilingual') {  
    // åˆ›å»ºè¯‘æ–‡å®¹å™¨  
    const transNode \= document.createElement('span');  
    transNode.className \= 'ollama-trans-text';  
    transNode.innerText \= \` ${translatedText}\`;  
      
    // æ’å…¥åˆ°åŸæ–‡ä¹‹å  
    if (textNode.nextSibling) {  
      parent.insertBefore(transNode, textNode.nextSibling);  
    } else {  
      parent.appendChild(transNode);  
    }  
  }  
}

// æ¥æ”¶æ¥è‡ª Popup çš„æŒ‡ä»¤  
chrome.runtime.onMessage.addListener((request) \=\> {  
  if (request.action \=== "start\_page\_translate") {  
    startFullPageTranslate(request.mode);  
  }  
});

// Tooltip UI è¾…åŠ©å‡½æ•° (ç®€ç•¥)  
function showTooltip(x, y, text) { /\* åˆ›å»ºå¹¶æ˜¾ç¤ºç»å¯¹å®šä½çš„ div \*/ }  
function updateTooltip(text) { /\* æ›´æ–° div å†…å®¹ \*/ }

### **3.5 æ ·å¼æ³¨å…¥ (styles.css)**

ç¾åŒ–åŒè¯­å¯¹ç…§çš„æ˜¾ç¤ºï¼Œé˜²æ­¢é¡µé¢å˜å¾—å¤ªä¹±ã€‚

CSS

/\* åˆ’è¯ç¿»è¯‘çš„æµ®å±‚ \*/  
\#ollama-tooltip {  
  position: absolute;  
  background: \#333;  
  color: \#fff;  
  padding: 8px 12px;  
  border-radius: 4px;  
  font-size: 14px;  
  z-index: 99999;  
  box-shadow: 0 2px 10px rgba(0,0,0,0.2);  
  max-width: 300px;  
}

/\* åŒè¯­æ¨¡å¼ä¸‹çš„è¯‘æ–‡æ ·å¼ \*/  
.ollama-trans-text {  
  color: \#d94518; /\* ä½¿ç”¨é†’ç›®çš„é¢œè‰²åŒºåˆ† \*/  
  font-weight: 500;  
  margin-left: 4px;  
  font-size: 0.95em;  
  background-color: rgba(255, 230, 0, 0.1); /\* æ·¡æ·¡çš„èƒŒæ™¯è‰² \*/  
  border-radius: 2px;  
}

### **3.6 å¼¹çª—æ§åˆ¶ (popup.html & popup.js)**

HTML

\<style\>  
  body { width: 200px; padding: 10px; font-family: sans-serif; }  
  button { width: 100%; margin: 5px 0; padding: 8px; cursor: pointer; }  
  .mode-btn { background: \#f0f0f0; border: 1px solid \#ccc; }  
  .mode-btn:hover { background: \#e0e0e0; }  
\</style\>

\<h3\>Ollama Translator\</h3\>  
\<button id\="btn-replace" class\="mode-btn"\>è¦†ç›–ç¿»è¯‘ (æ•´é¡µ)\</button\>  
\<button id\="btn-bilingual" class\="mode-btn"\>åŒè¯­å¯¹ç…§ (æ•´é¡µ)\</button\>  
\<div id\="status"\>Ready\</div\>

\<script src\="popup.js"\>\</script\>

JavaScript

// popup.js  
document.getElementById('btn-replace').addEventListener('click', () \=\> {  
  sendCommand('replace');  
});

document.getElementById('btn-bilingual').addEventListener('click', () \=\> {  
  sendCommand('bilingual');  
});

function sendCommand(mode) {  
  // è·å–å½“å‰æ ‡ç­¾é¡µå¹¶å‘é€æ¶ˆæ¯  
  chrome.tabs.query({active: true, currentWindow: true}, (tabs) \=\> {  
    chrome.tabs.sendMessage(tabs\[0\].id, {  
      action: "start\_page\_translate",  
      mode: mode  
    });  
    window.close();  
  });  
}

## ---


## **5\. è¿›é˜¶ä¼˜åŒ–å»ºè®® (é’ˆå¯¹ fymodel)**

* **Prompt è°ƒä¼˜**: ä¸åŒçš„æ¨¡å‹å¯¹ Prompt æ•æ„Ÿåº¦ä¸åŒã€‚å¦‚æœ fymodel è¿”å›äº†å¤šä½™çš„è§£é‡Šæ€§æ–‡å­—ï¼ˆå¦‚ "Here is the translation:"ï¼‰ï¼Œä½ éœ€è¦åœ¨ background.js ä¸­è°ƒæ•´ Prompt æˆ–ä½¿ç”¨æ­£åˆ™æ¸…æ´—ç»“æœã€‚  
* **ç¼“å­˜æœºåˆ¶**: åœ¨ background.js ä¸­å»ºç«‹ä¸€ä¸ª Map\<String, String\> ç¼“å­˜ã€‚å¦‚æœç”¨æˆ·æ»šåŠ¨å›å»æˆ–é‡åˆ°ç›¸åŒçš„å¥å­ï¼ˆå¦‚ "Read More"ï¼‰ï¼Œç›´æ¥ä»å†…å­˜è¯»å–ï¼Œæ— éœ€è¯·æ±‚ Ollamaã€‚  
* **æµå¼è¾“å‡º (Streaming)**: ä¸ºäº†æè‡´ä½“éªŒï¼Œå¯ä»¥å°† background.js æ”¹ä¸ºå¤„ç† Stream å“åº”ï¼Œä½†è¿™ä¼šå¢åŠ ä»£ç å¤æ‚åº¦ï¼ˆéœ€è¦ Content Script å®æ—¶æ›´æ–° DOM æ–‡å­—ï¼‰ï¼Œå»ºè®®åœ¨ V2 ç‰ˆæœ¬å®æ–½ã€‚