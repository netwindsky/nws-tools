# NWS Tools 模块化重构方案

## 可行性结论
Chrome 扩展完全支持按模块/功能拆分代码，并通过 content scripts、service worker（background）、options 页面等多入口进行加载与协作。当前项目已具备模块化雏形（[ModuleBase.js](file:///e:/Aworkplace/chrome%20%E6%8F%92%E4%BB%B6/nwsTools/js/modules/core/ModuleBase.js)、[ModuleManager.js](file:///e:/Aworkplace/chrome%20%E6%8F%92%E4%BB%B6/nwsTools/js/modules/core/ModuleManager.js)、[main.js](file:///e:/Aworkplace/chrome%20%E6%8F%92%E4%BB%B6/nwsTools/js/main.js)），因此将配置、逻辑、后台访问、数据处理拆分为各自模块是可行且可控的。

## 当前结构与问题定位
现有目录已经有分层，但仍存在以下问题：
- 单文件职责过重：如 [toolsbar.js](file:///e:/Aworkplace/chrome%20%E6%8F%92%E4%BB%B6/nwsTools/js/content-scripts/toolsbar.js)、[TranslationModule.js](file:///e:/Aworkplace/chrome%20%E6%8F%92%E4%BB%B6/nwsTools/js/modules/features/TranslationModule.js) 混合了 UI、配置、网络与业务逻辑。
- 配置分散：options 页保存与模块配置存在多处写入点，缺少统一配置入口。
- 后台访问耦合：后台消息监听和具体功能逻辑混在同一脚本中，如 [background.js](file:///e:/Aworkplace/chrome%20%E6%8F%92%E4%BB%B6/nwsTools/js/background/background.js)。
- 数据与业务无边界：翻译、总结、图片处理等功能直接操作 DOM 与存储，难以复用与测试。

## 目标结构（建议目录 - 方案 A）
在现有框架基础上，采用“入口层 + 业务功能包 + 基础设施层”的方式拆分，将业务模块按文件夹独立管理。同时规范资源文件（CSS/i18n）的存放位置：

```
nwsTools/
├── _locales/                   # [新增] 多语言定义 (Chrome 标准)
│   ├── en/messages.json
│   └── zh_CN/messages.json
├── css/                        # 全局样式库
│   ├── variables.css           # [新增] CSS 变量（主题色、字号）
│   ├── base.css                # [新增] Reset 与通用原子类
│   └── components/             # [新增] 通用 UI 组件样式
├── js/
│   ├── app/
│   │   ├── content/
│   │   │   ├── toolsbar/                  # 工具栏入口与 UI 事件
│   │   │   └── site/                       # 站点定制入口（civitai/aliyun）
│   │   ├── options/                        # 设置页入口
│   │   └── background/                     # Service Worker 入口
│   ├── modules/
│   │   ├── core/                           # 核心框架（ModuleBase/ModuleManager）
│   │   ├── ui/                             # 通用 UI 组件（Notification/Sidebar）
│   │   └── features/                       # 业务功能包（按功能命名文件夹）
│   │       ├── translation/                # 翻译功能包
│   │       │   ├── TranslationModule.js    # 模块主逻辑
│   │       │   ├── TranslationView.js      # 翻译专用 UI
│   │       │   ├── TranslationService.js   # 翻译 API 服务
│   │       │   └── style.css               # [可选] 模块私有样式
│   │       ├── summary/                    # 总结功能包
│   │       ├── image-downloader/           # 图片下载功能包
│   │       └── element-highlighter/        # 元素高亮功能包
│   ├── services/
│   │   ├── storage/                        # 统一配置读写服务
│   │   ├── chrome/                         # Chrome API 抽象封装
│   │   └── i18n/                           # [新增] 国际化服务
│   ├── shared/
│   │   ├── events/                         # 跨模块事件定义
│   │   └── constants/                      # 全局常量与枚举
│   └── utils/                              # dom-helper / error-handler 等工具类
```

## 模块拆分策略
按照“功能内聚 + 目录自治”的原则，将每个业务功能拆分为独立的文件夹：

### 1) 业务功能包 (Feature Bundles)
每个功能文件夹（如 `translation/`）内部实行自给自足：
- **Module**: 继承 `ModuleBase`，负责生命周期、状态管理与模块间通信。
- **Service**: 负责该功能相关的网络请求（如 API 调用）或复杂计算逻辑。
- **View/UI**: 如果该功能有专属的复杂 UI（如翻译浮窗），则独立为 View 类。

### 2) 核心与通用 UI (Core & Shared UI)
- **core/**: 存放不随业务变化的框架代码。
- **ui/**: 存放跨功能通用的 UI 模块（如全局通知、侧边栏容器）。

### 3) 基础设施服务 (Infrastructure Services)
- 将配置读写、消息路由、Chrome API 调用抽象为单例 Service，供所有 Feature 文件夹内的模块调用。

## 资源管理与国际化方案

### 1) 全局样式管理 (Global Styles)
- **css/variables.css**: 定义 `:root` 下的 CSS 变量（颜色、字体、间距），作为 Design Token。
- **css/base.css**: 包含 CSS Reset 和基础排版样式，确保跨站点的样式一致性。
- **css/components/**: 存放通用组件（如 Button, Card, Modal）的原子样式。
- **模块样式隔离**:
    - 业务模块（如翻译浮窗）应尽量使用 Shadow DOM 隔离样式。
    - 若必须注入页面，所有类名必须以 `.nws-` 开头，并使用 `css/modules/{module}.css` 或在 JS 中动态注入。

### 2) 多语言支持 (Internationalization)
- **标准机制**: 严格遵循 Chrome `_locales` 标准，所有用户可见文本均抽取到 `messages.json`。
- **I18nService**: 在 `js/services/i18n/` 下封装 `I18nService`：
    - 提供 `t(key, placeholders)` 方法，封装 `chrome.i18n.getMessage`。
    - 支持动态内容的模板替换。
    - 提供语言切换与回退逻辑（如 zh-CN -> en）。
- **开发流程**: 新增 UI 文本 -> 更新 `messages.json` -> 代码中替换为 `I18nService.t('key')`。

## 配置与数据管理方案
建立统一配置中心，避免散落多处写入：
- **shared/constants**: 维护每个模块的默认配置、Schema 定义与迁移映射。
- **services/storage**: 负责底层 `chrome.storage` 的读写，提供 `getConfig`、`setConfig` 等标准化接口。
- **options 页面**: 只通过 `StorageService` 进行交互，不再直接触碰业务模块。

建议配置流向：
```
options UI -> StorageService -> Module (via Config Update Event)
```

## 后台访问与消息解耦
将 `background` 的职责剥离，专注于调度：
- **MessageRouter**: 位于 `app/background/`，负责将 Chrome 消息转发到对应的 Feature 文件夹下的 Service。
- **BackgroundTasks**: 处理跨标签页的任务（如下载管理、右键菜单生成）。
- **Service 层**: 业务逻辑（如 AI 请求）完全在 Service 中实现，不依赖特定环境。

## 迁移路线图（低风险分阶段）
### 阶段 1：结构整理与接口定义
- 统一模块命名与目录规范
- 抽象 StorageService 与 MessageRouter
- 建立 shared/constants 与 shared/events

### 阶段 2：业务模块解耦
- TranslationModule/ SummaryModule 分离网络与配置逻辑到 service 层
- 统一模块间事件通信，替换直接耦合调用

### 阶段 3：入口瘦身与清理
- toolsbar 只保留 UI 和事件触发
- options 只负责表单逻辑与调用配置服务
- background 只保留消息路由与 Chrome API 入口

### 阶段 4：兼容与验证
- 映射旧配置到新结构
- 增量测试各功能模块
- 清理遗留脚本与无用依赖

## 风险与对策
- 风险：模块间事件与消息定义不统一
  - 对策：建立 shared/events 统一事件名与 payload 结构
- 风险：配置迁移导致旧用户设置失效
  - 对策：在 `shared/constants` 或专用 Service 中提供兼容迁移逻辑
- 风险：Chrome MV3 生命周期限制导致初始化失败
  - 对策：入口层延迟加载模块，使用 ModuleManager 管理生命周期

## 预期收益
- 功能隔离：单文件职责更清晰，维护成本降低
- 配置统一：设置项与模块配置一致性提升
- 复用能力：翻译/总结等共用服务可复用
- 可测试性：服务层可在隔离环境中测试

## 参考现有模块化基础
- [ModuleBase.js](file:///e:/Aworkplace/chrome%20%E6%8F%92%E4%BB%B6/nwsTools/js/modules/core/ModuleBase.js)
- [ModuleManager.js](file:///e:/Aworkplace/chrome%20%E6%8F%92%E4%BB%B6/nwsTools/js/modules/core/ModuleManager.js)
- [main.js](file:///e:/Aworkplace/chrome%20%E6%8F%92%E4%BB%B6/nwsTools/js/main.js)
- [ConfigManager.js](file:///e:/Aworkplace/chrome%20%E6%8F%92%E4%BB%B6/nwsTools/js/utils/ConfigManager.js)
